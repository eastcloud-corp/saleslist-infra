name: Deploy to Sakura VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
  PROJECT_ROOT: /opt/salesnav
  COMPOSE_FILE: saleslist-infra/docker-compose/prd/docker-compose.yml

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-backend
          path: backend

      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-front
          path: front

      - name: Prepare files for deployment
        run: |
          mkdir -p bundle
          rsync -a backend/ bundle/saleslist-backend/
          rsync -a front/ bundle/saleslist-front/
          rsync -a infra/ bundle/saleslist-infra/

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY }}

      - name: Add VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          rsync -az --delete \
            --omit-dir-times --no-perms --no-owner --no-group \
            --exclude 'saleslist-infra/docker-compose/prd/.env' \
            bundle/ ${VPS_USER}@${VPS_HOST}:${PROJECT_ROOT}/

          ssh ${VPS_USER}@${VPS_HOST} <<EOS
          set -e
          cd ${PROJECT_ROOT}
          sudo docker compose -f ${COMPOSE_FILE} pull backend frontend
          sudo docker compose -f ${COMPOSE_FILE} build backend frontend worker beat
          sudo docker compose -f ${COMPOSE_FILE} up -d db redis
          sudo docker compose -f ${COMPOSE_FILE} run --rm backend python manage.py migrate
          sudo docker compose -f ${COMPOSE_FILE} up -d backend worker beat frontend
          sudo docker image prune -f
          EOS
