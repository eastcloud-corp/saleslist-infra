name: Deploy to Sakura VPS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
  PROJECT_ROOT: /opt/salesnav
  COMPOSE_FILE: saleslist-infra/docker-compose/prd/docker-compose.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-backend
          path: backend

      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-front
          path: front

      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-docs
          path: docs

      - name: Prepare files for deployment
        run: |
          mkdir -p bundle
          rsync -a backend/ bundle/saleslist-backend/
          rsync -a front/ bundle/saleslist-front/
          rsync -a infra/ bundle/saleslist-infra/
          rsync -a docs/ bundle/saleslist-docs/

      - name: Generate production env file
        run: |
          escape_dollar() {
            printf '%s' "$1" | sed 's/\$/$$/g'
          }

          DJANGO_SECRET_KEY_ESCAPED=$(escape_dollar "${{ secrets.DJANGO_SECRET_KEY }}")
          DB_PASSWORD_ESCAPED=$(escape_dollar "${{ secrets.DB_PASSWORD }}")
          POWERPLEXY_API_KEY_ESCAPED=$(escape_dollar "${{ secrets.POWERPLEXY_API_KEY }}")
          MFA_EMAIL_FROM_ESCAPED=$(escape_dollar "${{ secrets.MFA_EMAIL_FROM }}")
          SENDGRID_API_KEY_ESCAPED=$(escape_dollar "${{ secrets.SENDGRID_API_KEY }}")

          cat <<EOF > bundle/saleslist-infra/docker-compose/prd/.env
          DJANGO_SETTINGS_MODULE=saleslist_backend.settings.prod
          DJANGO_DEBUG=False
          DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY_ESCAPED
          DJANGO_ALLOWED_HOSTS=sales-navigator.east-cloud.jp,153.120.128.27,localhost
          CORS_ALLOWED_ORIGINS=https://sales-navigator.east-cloud.jp
          CORS_ALLOW_ALL_ORIGINS=False
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=saleslist_production
          DB_USER=saleslist_prod_user
          DB_PASSWORD=$DB_PASSWORD_ESCAPED
          REDIS_URL=redis://redis:6379/1
          CELERY_BROKER_URL=redis://redis:6379/1
          CELERY_RESULT_BACKEND=redis://redis:6379/1
          CSRF_TRUSTED_ORIGINS=https://sales-navigator.east-cloud.jp
          CSRF_COOKIE_SECURE=True
          SESSION_COOKIE_SECURE=True
          POWERPLEXY_API_KEY=$POWERPLEXY_API_KEY_ESCAPED
          POWERPLEXY_MONTHLY_COST_LIMIT=150
          POWERPLEXY_COST_PER_REQUEST=0.05
          POWERPLEXY_MODEL=sonar-medium
          MFA_EMAIL_FROM=$MFA_EMAIL_FROM_ESCAPED
          SENDGRID_API_KEY=$SENDGRID_API_KEY_ESCAPED
          NEXT_PUBLIC_API_URL=https://sales-navigator.east-cloud.jp
          NEXT_PUBLIC_ENVIRONMENT=prd
          EOF

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY }}

      - name: Add VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          rsync -az --delete \
            --omit-dir-times --no-perms --no-owner --no-group \
            bundle/ ${VPS_USER}@${VPS_HOST}:${PROJECT_ROOT}/

          ssh ${VPS_USER}@${VPS_HOST} <<EOS
          set -ex
          cd ${PROJECT_ROOT}
          sudo docker compose -f ${COMPOSE_FILE} pull backend frontend
          sudo docker compose -f ${COMPOSE_FILE} build --no-cache backend frontend worker beat
          sudo docker compose -f ${COMPOSE_FILE} up -d db redis
          sudo docker compose -f ${COMPOSE_FILE} up -d backend
          sudo docker compose -f ${COMPOSE_FILE} exec -T backend python manage.py migrate --noinput
          sudo docker compose -f ${COMPOSE_FILE} up -d --build --force-recreate backend worker beat frontend
          sudo docker builder prune -af
          sudo docker image prune -f
          EOS
