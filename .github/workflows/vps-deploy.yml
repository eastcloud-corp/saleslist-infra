name: Deploy to Sakura VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
  PROJECT_ROOT: /opt/salesnav
  COMPOSE_FILE: saleslist-infra/docker-compose/prd/docker-compose.yml

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-backend
          path: backend

      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: eastcloud-corp/saleslist-front
          path: front

      - name: Prepare files for deployment
        run: |
          mkdir -p bundle
          rsync -a backend/ bundle/saleslist-backend/
          rsync -a front/ bundle/saleslist-front/
          rsync -a infra/ bundle/saleslist-infra/
          rsync -a backend/saleslist-docs/ bundle/saleslist-docs/

      - name: Generate production env file
        run: |
          cat <<'EOF' > bundle/saleslist-infra/docker-compose/prd/.env
          DJANGO_SETTINGS_MODULE=saleslist_backend.settings.prod
          DJANGO_DEBUG=False
          DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_ALLOWED_HOSTS=sales-navigator.east-cloud.jp,153.120.128.27,localhost
          CORS_ALLOWED_ORIGINS=https://sales-navigator.east-cloud.jp
          CORS_ALLOW_ALL_ORIGINS=False
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=saleslist_production
          DB_USER=saleslist_prod_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_URL=redis://redis:6379/1
          CELERY_BROKER_URL=redis://redis:6379/1
          CELERY_RESULT_BACKEND=redis://redis:6379/1
          POWERPLEXY_API_KEY=${{ secrets.POWERPLEXY_API_KEY }}
          POWERPLEXY_MONTHLY_COST_LIMIT=150
          POWERPLEXY_COST_PER_REQUEST=0.05
          POWERPLEXY_MODEL=sonar-medium
          MFA_EMAIL_FROM=${{ secrets.MFA_EMAIL_FROM }}
          SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
          NEXT_PUBLIC_API_URL=https://sales-navigator.east-cloud.jp
          NEXT_PUBLIC_ENVIRONMENT=prod
          EOF

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY }}

      - name: Add VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          rsync -az --delete \
            --omit-dir-times --no-perms --no-owner --no-group \
            bundle/ ${VPS_USER}@${VPS_HOST}:${PROJECT_ROOT}/

          ssh ${VPS_USER}@${VPS_HOST} <<EOS
          set -e
          cd ${PROJECT_ROOT}
          sudo docker compose -f ${COMPOSE_FILE} pull backend frontend
          sudo docker compose -f ${COMPOSE_FILE} build backend frontend worker beat
          sudo docker compose -f ${COMPOSE_FILE} up -d db redis
          sudo docker compose -f ${COMPOSE_FILE} run --rm backend python manage.py migrate
          sudo docker compose -f ${COMPOSE_FILE} up -d backend worker beat frontend
          sudo docker image prune -f
          EOS
