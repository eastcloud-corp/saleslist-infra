name: Deploy to VPS

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "🚀 セールスナビゲーター自動デプロイ開始"
            
            # Update repositories (with sudo)
            sudo mkdir -p /opt/salesnav
            cd /opt/salesnav
            sudo git clone https://github.com/eastcloud-corp/saleslist-backend.git || (cd saleslist-backend && sudo git pull)
            sudo git clone https://github.com/eastcloud-corp/saleslist-front.git || (cd saleslist-front && sudo git pull)
            sudo git clone https://github.com/eastcloud-corp/saleslist-infra.git || (cd saleslist-infra && sudo git pull)
            
            # Setup environment variables
            cd /opt/salesnav/saleslist-infra/docker-compose/prd
            sudo tee .env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            ALLOWED_HOSTS=153.120.128.27,localhost
            CORS_ALLOWED_ORIGINS=http://153.120.128.27,http://localhost:3000
            NEXT_PUBLIC_API_URL=http://localhost:8000
            EOF
            
            # Setup and start containers
            sudo docker compose down || true
            sudo docker compose up -d --build
            
            # Wait for services to start
            sleep 60
            
            # Health check with error handling
            if sudo docker compose ps | grep -q "Up"; then
              echo "✅ Services started"
              sudo docker compose logs --tail=5
            else
              echo "❌ Services failed"
              sudo docker compose logs
              exit 1
            fi
            
            echo "✅ デプロイ完了"
            echo "🌐 アクセス: http://153.120.128.27"