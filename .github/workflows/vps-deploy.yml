name: Deploy to VPS

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  NEXT_PUBLIC_API_URL: https://sales-navigator.east-cloud.jp

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ðŸš€ ã‚»ãƒ¼ãƒ«ã‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
            
            # Update repositories (with sudo)
            sudo mkdir -p /opt/salesnav
            cd /opt/salesnav
            sudo git clone https://github.com/eastcloud-corp/saleslist-backend.git || (cd saleslist-backend && sudo git pull)
            sudo git clone https://github.com/eastcloud-corp/saleslist-front.git || (cd saleslist-front && sudo git pull)
            sudo git clone https://github.com/eastcloud-corp/saleslist-infra.git || (cd saleslist-infra && sudo git pull)
            
            # Setup environment variables
            cd /opt/salesnav/saleslist-infra/docker-compose/prd
            sudo tee .env << EOF
            DB_HOST="db"
            DB_PORT="5432"
            DB_NAME="saleslist_production"
            DB_USER="saleslist_prod_user"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DJANGO_SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
            DEBUG="False"
            ALLOWED_HOSTS="sales-navigator.east-cloud.jp,153.120.128.27,localhost"
            CORS_ALLOWED_ORIGINS="https://sales-navigator.east-cloud.jp"
            NEXT_PUBLIC_API_URL="${{ env.NEXT_PUBLIC_API_URL }}"
            REDIS_URL="redis://redis:6379/1"
            EOF
            
            # Debug: ç’°å¢ƒå¤‰æ•°ç¢ºèª
            echo "ðŸ” GitHub Actionsç’°å¢ƒå¤‰æ•°:"
            echo "NEXT_PUBLIC_API_URL: ${{ env.NEXT_PUBLIC_API_URL }}"
            echo "ðŸ” .envãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
            grep NEXT_PUBLIC_API_URL .env
            echo "ðŸ” Docker buildæ™‚ã®ç’°å¢ƒå¤‰æ•°:"
            echo "NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"
            
            # Initial setup (only run if needed)
            if [ ! -f "/etc/nginx/sites-enabled/default" ]; then
              echo "ðŸ”§ åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ"
              
              # Install Nginx and Certbot
              sudo apt install -y nginx certbot python3-certbot-nginx
              
              # Setup Nginx configuration
              sudo tee /etc/nginx/sites-enabled/default << 'NGINX_EOF'
            server {
                listen 80;
                listen 443 ssl;
                server_name sales-navigator.east-cloud.jp;
                
                ssl_certificate /etc/letsencrypt/live/sales-navigator.east-cloud.jp/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/sales-navigator.east-cloud.jp/privkey.pem;
                
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                
                location /api/ {
                    proxy_pass http://localhost:8000/api/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                
                location /admin/ {
                    proxy_pass http://localhost:8000/admin/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                
                location /static/ {
                    proxy_pass http://localhost:8000/static/;
                }
                
                location /media/ {
                    proxy_pass http://localhost:8000/media/;
                }
            }
            NGINX_EOF
              
              # Get SSL certificate
              sudo systemctl start nginx
              sudo certbot --nginx -d sales-navigator.east-cloud.jp --non-interactive --agree-tos --email admin@budget-sales.com || true
              
              # Setup log structure
              sudo bash /opt/salesnav/saleslist-infra/scripts/setup-log-structure.sh
              
              # Setup cron jobs
              sudo bash /opt/salesnav/saleslist-infra/scripts/setup-ssl-cron.sh
              
              echo "âœ… åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
            else
              echo "âš¡ æ—¢å­˜ç’°å¢ƒã§ã®æ›´æ–°ãƒ‡ãƒ—ãƒ­ã‚¤"
            fi
            
            # Pre-deployment backup (if DB exists)
            if sudo docker compose ps | grep -q "saleslist_db_prd.*healthy"; then
              echo "ðŸ—„ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å‰DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ"
              sudo bash /opt/salesnav/saleslist-infra/scripts/backup-db.sh
            fi
            
            # Setup and start containers
            sudo docker compose down || true
            
            # Complete cache cleanup
            sudo docker system prune -af --volumes
            sudo docker builder prune -af
            
            # Rebuild with fresh cache and environment variables
            sudo NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }} docker compose build --no-cache --pull
            
            # Start services with detailed logging
            echo "ðŸš€ Starting services..."
            sudo docker compose up -d
            
            # Check initial startup
            echo "ðŸ” Initial service status:"
            sudo docker compose ps
            
            # Wait for initial startup
            sleep 45
            
            # Check for build/startup errors
            echo "ðŸ” Checking for startup errors:"
            sudo docker compose logs --tail=20
            
            # Force restart both services to ensure fresh deployment  
            echo "â™»ï¸ Restarting services for fresh deployment..."
            sudo docker compose restart backend
            sudo docker compose restart frontend
            
            # Wait for restart completion
            sleep 60
            
            # Enhanced health check and validation
            echo "ðŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼é–‹å§‹"
            
            # Service status check
            if sudo docker compose ps | grep -q "Up"; then
              echo "âœ… Services started"
              
              # Check each service individually
              echo "ðŸ” Backend service check:"
              curl -s -I http://localhost:8000/admin/ | head -1 || echo "Backend not responding"
              
              echo "ðŸ” Frontend service check:" 
              curl -s -I http://localhost:3000/ | head -1 || echo "Frontend not responding"
              
              # Verify environment variables in containers
              echo "ðŸ” Frontend environment validation:"
              sudo docker compose exec -T frontend printenv | grep NEXT_PUBLIC_API_URL || echo "ENV var missing"
              
              # Show recent logs for debugging
              echo "ðŸ“„ Recent backend logs:"
              sudo docker compose logs backend --tail=10
              echo "ðŸ“„ Recent frontend logs:"
              sudo docker compose logs frontend --tail=10
              
              echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
              echo "ðŸŒ æœ¬ç•ªURL: https://sales-navigator.east-cloud.jp" 
              echo "ðŸŒ IPç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹: http://153.120.128.27"
              
            else
              echo "âŒ Services failed to start"
              sudo docker compose ps
              sudo docker compose logs
              exit 1
            fi